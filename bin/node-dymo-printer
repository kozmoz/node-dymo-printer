#!/usr/bin/env node

import path from 'path';
import cli from 'cli';

// Read version info of ltpa-scraper.
import {DymoServices} from '../src/dymo-services.js';
import * as imageServices from '../src/image-services.js';
// jshint ignore:line
import packageJson from '../package.json' with {type: 'json'};

// Display app name and version from package.json on --version.
cli.setApp(packageJson.name, packageJson.version);

const options = cli.parse({
    'list-printers': [false, 'List all system printers found.'],
    version: [false, 'Returns application name and version']
});

const program = path.basename(process.argv[1]);
const arg1 = process.argv.length > 2 ? process.argv[2] : '';

// Show version info and exit.
if (options.version) {
    cli.info(`${packageJson.name} v${packageJson.version}`);
    process.exit(0);
}

if (options['list-printers']) {
    new DymoServices().listPrinters()
        .then(printers => {
            console.log(JSON.stringify(printers, null, 2));
            process.exit(0);
        })
        .catch(error => {
            cli.error(JSON.stringify(error, null, 2));
            process.exit(1);
        });
} else if (arg1) {
    // Print given text as label.
    const dymoServices = new DymoServices();
    const {imageWidth, imageHeight} = DymoServices.DYMO_LABELS['89mm x 28mm']; // Use a valid key
    imageServices.createImageWithText(imageWidth, imageHeight, 50, 128, arg1)
        .then(image => {
            // Rotate image for label writer.
            image.rotate(-90, true);
            imageServices.convertImageToBitmap(image)
                .then(bitmap => {
                    dymoServices.print(bitmap)
                        .then(() => process.exit(0))
                        .catch(error => {
                            cli.error(JSON.stringify(error, null, 2));
                            process.exit(1);
                        });
                })
                .catch(error => {
                    cli.error(JSON.stringify(error, null, 2));
                    process.exit(1);
                });
        })
        .catch(error => {
            cli.error(JSON.stringify(error, null, 2));
            process.exit(1);
        });
} else {
    // Use cli.error() to get nice red coloring.
    cli.error(`Provide at least one argument to ${program}`);
    cli.error(`See ${program} --help for details`);
    process.exit(1);
}

