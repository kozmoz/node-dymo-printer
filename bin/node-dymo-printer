#!/usr/bin/env node

import path from 'path';
import cli from 'cli';

// Read version info of ltpa-scraper.
import {DymoServices} from '../dist/dymo-services.js';
import * as imageServices from '../dist/image-services.js';

// Display app name and version from package.json on --version.
cli.setApp('package.json');

const options = cli.parse({
    'list-printers': [false, 'List all system printers found.'],
    version: [false, 'Returns application name and version']
});

const program = path.basename(process.argv[1]);
const arg1 = process.argv.length > 2 ? process.argv[2] : '';

// Show version info and exit.
if (options.version) {
    cli.info(`${cli.app} v${cli.version}`);
    process.exit(0);
}

if (options['list-printers']) {
    try {
        const printers = await new DymoServices().listPrinters();
        console.log(JSON.stringify(printers, null, 2));
        process.exit(0);
    } catch (error) {
        cli.error(error instanceof Error ? error.message : JSON.stringify(error, null, 2));
        process.exit(1);
    }
} else if (arg1) {
    // Print given text as label.
    try {
        const dymoServices = new DymoServices();
        const {imageWidth, imageHeight} = DymoServices.DYMO_LABELS['89mm x 28mm']; // Use a valid key
        const image = await imageServices.createImageWithText(imageWidth, imageHeight, 50, 128, arg1);
        // Rotate image for the label writer.
        image.rotate(-90, true);
        const bitmap = await imageServices.convertImageToBitmap(image);
        await dymoServices.printBitmap(bitmap);
        process.exit(0);
    } catch (error) {
        cli.error(error instanceof Error ? error.message : JSON.stringify(error, null, 2));
        process.exit(1);
    }
} else {
    // Use cli.error() to get nice red coloring.
    cli.error(`Provide at least one argument to ${program}`);
    cli.error(`See ${program} --help for details`);
    process.exit(1);
}

